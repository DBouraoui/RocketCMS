{% extends './Themes/Business/base.html.twig' %}

{% block title %}Médiathèque{% endblock %}

{% block body %}
    <div class="min-h-screen bg-white text-neutral-900 py-16 px-6">
        <div class="max-w-6xl mx-auto">
            <h1 class="text-4xl font-extrabold text-center mb-12 tracking-tight">
                Ma Médiathèque
            </h1>

            {% if mediaLibrary is not empty %}
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                    {% for media in mediaLibrary %}
                        <div class="border border-neutral-200 rounded-2xl shadow-sm bg-neutral-50 hover:shadow-md transition p-5 flex flex-col">
                            {% if media.picture %}
                                <div
                                    class="relative cursor-pointer group"
                                    onclick="openCarousel({{ loop.index0 }})"
                                >
                                    <img
                                        src="{{ asset(media.picture) }}"
                                        alt="{{ media.title }}"
                                        class="w-full h-56 object-cover rounded-xl mb-4 group-hover:opacity-90 transition"
                                    >
                                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 rounded-xl transition flex items-center justify-center">
                                        <div class="opacity-0 group-hover:opacity-100 transition">
                                            <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"/>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <div class="w-full h-56 bg-neutral-200 flex items-center justify-center rounded-xl text-neutral-500 mb-4">
                                    <i class="fa-regular fa-image text-2xl"></i>
                                </div>
                            {% endif %}

                            <h2 class="text-xl font-semibold text-neutral-900 mb-2">
                                {{ media.title }}
                            </h2>

                            <div class="prose prose-neutral text-sm text-neutral-700 leading-relaxed mb-3 flex-grow">
                                {{ media.description|markdown_to_html|striptags|length > 120
                                ? media.description|markdown_to_html|striptags|slice(0, 120) ~ '…'
                                : media.description|markdown_to_html|striptags }}
                            </div>

                            <div class="mt-auto pt-3 text-xs text-neutral-500 border-t border-neutral-200">
                                Publié le {{ media.createdAt|date('d/m/Y à H:i') }}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-20">
                    <p class="text-neutral-500 text-lg">
                        Aucun média enregistré pour le moment.
                    </p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Carousel Modal -->
    <div id="carouselModal" class="fixed inset-0 bg-black/95 flex items-center justify-center z-50 hidden">
        <div class="relative w-full h-full flex items-center justify-center">

            <!-- Bouton Fermer -->
            <button
                onclick="closeCarousel()"
                class="absolute top-6 right-6 z-10 text-white hover:text-neutral-300 transition"
                aria-label="Fermer"
            >
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>

            <!-- Navigation Gauche -->
            <button
                onclick="previousSlide()"
                class="absolute left-6 z-10 text-white hover:text-neutral-300 transition p-3 bg-black/30 rounded-full hover:bg-black/50"
                aria-label="Précédent"
            >
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </button>

            <!-- Contenu du Carousel -->
            <div class="max-w-5xl w-full mx-auto px-20">
                <div class="bg-black rounded-2xl overflow-hidden shadow-2xl">
                    <!-- Image -->
                    <div class="relative">
                        <img
                            id="carouselImage"
                            src=""
                            alt=""
                            class="w-full h-[60vh] object-contain bg-neutral-900"
                        >
                        <!-- Indicateur de position -->
                        <div class="absolute top-4 left-4 bg-black/70 text-white px-3 py-1 rounded-full text-sm">
                            <span id="currentSlide">1</span> / <span id="totalSlides">1</span>
                        </div>
                    </div>

                    <!-- Informations -->
                    <div class="p-6 bg-neutral-900 text-white">
                        <h2 id="carouselTitle" class="text-2xl font-bold mb-3"></h2>
                        <div id="carouselDescription" class="text-neutral-300 leading-relaxed mb-4 max-h-32 overflow-y-auto"></div>
                        <div id="carouselDate" class="text-sm text-neutral-500"></div>
                    </div>
                </div>
            </div>

            <!-- Navigation Droite -->
            <button
                onclick="nextSlide()"
                class="absolute right-6 z-10 text-white hover:text-neutral-300 transition p-3 bg-black/30 rounded-full hover:bg-black/50"
                aria-label="Suivant"
            >
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </button>
        </div>
    </div>

    <script>
        const mediaData = [
            {% for media in mediaLibrary %}
            {
                picture: "{{ asset(media.picture) }}",
                title: {{ media.title|json_encode|raw }},
                description: {{ media.description|markdown_to_html|raw|json_encode|raw }},
                date: "{{ media.createdAt|date('d/m/Y à H:i') }}"
            }{{ loop.last ? '' : ',' }}
            {% endfor %}
        ];

        let currentIndex = 0;

        function openCarousel(index) {
            currentIndex = index;
            updateCarousel();
            document.getElementById('carouselModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeCarousel() {
            document.getElementById('carouselModal').classList.add('hidden');
            document.body.style.overflow = '';
        }

        function updateCarousel() {
            const media = mediaData[currentIndex];

            document.getElementById('carouselImage').src = media.picture;
            document.getElementById('carouselImage').alt = media.title;
            document.getElementById('carouselTitle').textContent = media.title;
            document.getElementById('carouselDescription').innerHTML = media.description;
            document.getElementById('carouselDate').textContent = 'Publié le ' + media.date;
            document.getElementById('currentSlide').textContent = currentIndex + 1;
            document.getElementById('totalSlides').textContent = mediaData.length;
        }

        function nextSlide() {
            currentIndex = (currentIndex + 1) % mediaData.length;
            updateCarousel();
        }

        function previousSlide() {
            currentIndex = (currentIndex - 1 + mediaData.length) % mediaData.length;
            updateCarousel();
        }

        // Navigation au clavier
        document.addEventListener('keydown', (e) => {
            const modal = document.getElementById('carouselModal');
            if (!modal.classList.contains('hidden')) {
                if (e.key === 'ArrowRight') nextSlide();
                if (e.key === 'ArrowLeft') previousSlide();
                if (e.key === 'Escape') closeCarousel();
            }
        });

        // Fermer en cliquant sur le fond
        document.getElementById('carouselModal').addEventListener('click', (e) => {
            if (e.target.id === 'carouselModal') closeCarousel();
        });
    </script>
{% endblock %}
